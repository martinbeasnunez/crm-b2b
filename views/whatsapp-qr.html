<div style="max-width: 800px; margin: 20px auto; padding: 20px; text-align: center;">
    <h2>📱 Conexión WhatsApp</h2>
    
    <div style="background: #f8f9fa; border-radius: 10px; padding: 15px; margin: 20px 0; border-left: 4px solid #ffc107;">
        <p><strong>🔧 Para conectar WhatsApp al CRM:</strong></p>
        <ol style="text-align: left; max-width: 500px; margin: 0 auto;">
            <li>Abre en otra pestaña: <a href="https://crmwhatsapp3001.loca.lt" target="_blank" style="color: #007bff; text-decoration: underline;">Servidor WhatsApp</a></li>
            <li>Escanea el código QR que aparece</li>
            <li>Una vez conectado, regresa al Pipeline</li>
            <li>Arrastra cualquier tarjeta a "En Conversación"</li>
            <li>¡El mensaje se enviará automáticamente! 🚀</li>
        </ol>
    </div>

    <div style="background: #d4edda; border-radius: 10px; padding: 15px; margin: 20px 0; border-left: 4px solid #28a745;">
        <h3>✅ ¿Cómo funciona?</h3>
        <p style="text-align: left; max-width: 600px; margin: 0 auto;">
            <strong>El WhatsApp está integrado directamente en el Pipeline:</strong><br>
            • Cuando arrastras una tarjeta a <strong>"En Conversación"</strong><br>
            • Se envía automáticamente un mensaje personalizado al contacto<br>
            • No necesitas hacer nada más, ¡es automático! 🎯
        </p>
    </div>

    <div style="background: #fff3cd; border-radius: 10px; padding: 15px; margin: 20px 0; border-left: 4px solid #ffc107;">
        <h3>⚠️ Importante</h3>
        <p style="text-align: left; max-width: 600px; margin: 0 auto;">
            • El servidor WhatsApp debe estar ejecutándose<br>
            • Solo necesitas conectar WhatsApp <strong>una vez</strong><br>
            • Los mensajes se envían solo cuando mueves tarjetas a "En Conversación"<br>
            • Asegúrate de que los leads tengan número de teléfono
        </p>
    </div>

    <div style="margin: 30px 0;">
    <button onclick="window.open('https://crmwhatsapp3001.loca.lt', '_blank')" 
                style="background: #25D366; color: white; border: none; padding: 15px 30px; border-radius: 25px; cursor: pointer; font-size: 16px; margin: 10px;">
            🔗 Abrir WhatsApp QR
        </button>
        <button onclick="showTab('pipeline')" 
                style="background: #007bff; color: white; border: none; padding: 15px 30px; border-radius: 25px; cursor: pointer; font-size: 16px; margin: 10px;">
            📊 Ir al Pipeline
        </button>
    </div>

    <div style="background: #f8f9fa; border-radius: 10px; padding: 15px; margin: 20px 0;">
        <h3>🚀 Estado del servidor</h3>
        <p id="server-status" style="margin: 10px 0;">Verificando conexión...</p>
        <button onclick="checkServerStatus()" 
                style="background: #17a2b8; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
            🔄 Verificar Estado
        </button>
    </div>

    <div id="qr-section" style="background: white; border-radius: 15px; padding: 30px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin: 20px 0; display: none;">
        <h3>📱 Código QR WhatsApp</h3>
        <div id="qr-container" style="width: 300px; height: 300px; margin: 20px auto; border: 3px solid #25D366; border-radius: 15px; display: flex; align-items: center; justify-content: center; background: #f8f9fa;">
            <div id="qr-placeholder" style="color: #666; font-size: 16px;">🔄 Cargando código QR...</div>
        </div>
        <button onclick="loadQRCode()" 
                style="background: #25D366; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 5px;">
            🔄 Refrescar QR
        </button>
    </div>
</div>

<script>
function checkServerStatus() {
    const statusEl = document.getElementById('server-status');
    statusEl.textContent = '🔄 Verificando...';
    
    fetch('https://crmwhatsapp3001.loca.lt/api/whatsapp/status')
        .then(response => response.json())
        .then(data => {
            if (data.authenticated) {
                statusEl.innerHTML = '✅ <strong style="color: #28a745;">WhatsApp Conectado</strong> - ¡Listo para enviar mensajes!';
                document.getElementById('qr-section').style.display = 'none';
            } else {
                statusEl.innerHTML = '⚠️ <strong style="color: #ffc107;">WhatsApp NO conectado</strong> - Escanea el QR o <a href="https://crmwhatsapp3001.loca.lt" target="_blank" style="color: #007bff;">ábrelo en otra pestaña</a>';
                document.getElementById('qr-section').style.display = 'block';
                loadQRCode();
            }
        })
        .catch(error => {
            statusEl.innerHTML = '❌ <strong style="color: #dc3545;">Servidor no disponible</strong> - Inicia el servidor WhatsApp';
            document.getElementById('qr-section').style.display = 'none';
        });
}

function loadQRCode() {
    const qrContainer = document.getElementById('qr-container');
    const qrPlaceholder = document.getElementById('qr-placeholder');
    
    qrPlaceholder.textContent = '🔄 Cargando código QR...';
    
    fetch('https://crmwhatsapp3001.loca.lt/api/whatsapp/status')
        .then(response => response.json())
        .then(data => {
            if (data.qr) {
                qrContainer.innerHTML = '<img src="' + data.qr + '" style="width: 100%; height: 100%; object-fit: contain;" />';
            } else if (data.authenticated) {
                qrPlaceholder.textContent = '✅ WhatsApp ya está conectado';
            } else {
                qrPlaceholder.textContent = '⚠️ QR no disponible. Reinicia el servidor.';
            }
        })
        .catch(error => {
            qrPlaceholder.textContent = '❌ Error al cargar QR';
        });
}

// Verificar estado al cargar
setTimeout(checkServerStatus, 1000);

// Actualizar estado cada 5 segundos
setInterval(checkServerStatus, 5000);
</script>
